<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logbook Aviobridge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
    
    <!-- Load Supabase library FIRST -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Initialize Supabase client immediately and expose to window -->
    <script>
        // Konfigurasi Supabase
        const SUPABASE_URL = 'https://voqvauapafsdcmuswsnq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZ' +
            'SIsInJlZiI6InZvcXZhdWFwYWZzZGNtdXN3c25xIiwicm9sZSI6ImFub24iLCJpYXQiOjE' +
            '3NjYxNDMxNTYsImV4cCI6MjA4MTcxOTE1Nn0.IJG7ofqfc4Qy44KlbTDGzo4OoQwO0xTXU' +
            'wKPt04kRnI';

        // Create and expose supabaseClient to window scope IMMEDIATELY
        // This ensures logic.js logout function can access it
        if (typeof window.supabase !== 'undefined') {
            const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            window.supabaseClient = supabaseClient;
            console.log('Supabase client initialized and exposed to window');
        } else {
            console.error('Supabase library not loaded!');
        }
    </script>
    
    <!-- Load logic.js AFTER Supabase client is initialized -->
    <script src="assets/logic.js"></script>
    
    <!-- Ensure logout function is available -->
    <script>
        // Fallback logout function if logic.js doesn't load properly
        if (typeof window.logout === 'undefined') {
            window.logout = async function() {
                const confirmLogout = confirm('Apakah Anda yakin ingin keluar dari sistem?');
                if (!confirmLogout) return false;
                
                try {
                    sessionStorage.clear();
                    localStorage.clear();
                    
                    if (window.supabaseClient && window.supabaseClient.auth) {
                        await window.supabaseClient.auth.signOut();
                    }
                    
                    window.location.href = 'index.html';
                    return true;
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Logout berhasil. Anda akan diarahkan ke halaman login.');
                    window.location.href = 'index.html';
                    return true;
                }
            };
        }
    </script>
    <style>
        .hidden { display: none; }
        .form-check-input { cursor: pointer; border: 1px solid #0d6efd; }
        
        /* Sidebar Styles */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            min-width: 250px;
            max-width: 250px;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            transition: left 0.3s ease, transform 0.3s ease;
            min-height: 100vh;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
            transform: translateX(0);
        }

        #sidebar.active {
            left: -250px !important;
            transform: translateX(-250px) !important;
        }

        #sidebar .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
        }

        #sidebar ul.components {
            padding: 20px 0;
        }

        #sidebar ul li {
            padding: 10px;
            font-size: 1.1em;
            display: block;
        }

        #sidebar ul li a {
            padding: 10px 15px;
            font-size: 1em;
            display: block;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-radius: 5px;
        }

        #sidebar ul li a:hover,
        #sidebar ul li a.active {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }

        #sidebar ul li a i {
            margin-right: 10px;
        }

        #content {
            margin-left: 250px;
            width: calc(100% - 250px);
            padding: 20px;
            min-height: 100vh;
            transition: margin-left 0.3s ease, width 0.3s ease;
        }

        #sidebar.active ~ #content {
            margin-left: 0 !important;
            width: 100% !important;
        }

        .wrapper {
            width: 100%;
            position: relative;
        }
        
        #sidebarCollapse {
            background: #1e3c72;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #sidebarCollapse:hover {
            background: #2a5298;
        }
        
        
        /* Print Header - Only visible when printing */
        .print-header {
            display: none;
        }
        
        /* CSS Khusus Cetak */
        @media print {
            /* Hide sidebar and unnecessary elements */
            #sidebar,
            .no-print, 
            .btn, 
            .modal,
            #sidebarCollapse,
            .card-header {
                display: none !important;
            }
            
            /* Show print header */
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #333;
            }
            
            .print-header h2 {
                margin: 0;
                font-size: 20px;
                font-weight: bold;
                color: #000;
            }
            
            .print-header h3 {
                margin: 5px 0;
                font-size: 16px;
                font-weight: bold;
                color: #000;
            }
            
            .print-header p {
                margin: 3px 0;
                font-size: 12px;
                color: #333;
            }
            
            /* Adjust content for print */
            #content {
                margin-left: 0 !important;
                width: 100% !important;
                padding: 20px !important;
            }
            
            .card {
                box-shadow: none;
                border: none;
            }
            
            .card-body {
                padding: 0 !important;
            }
            
            body {
                background-color: white;
            }
            
            /* Pastikan tabel tercetak penuh */
            .table-responsive {
                overflow: visible !important;
            }
            
            /* Table styling for print */
            .table {
                font-size: 11px;
                border-collapse: collapse;
                width: 100%;
            }
            
            .table th,
            .table td {
                border: 1px solid #000 !important;
                padding: 5px !important;
            }
            
            .table thead th {
                background-color: #f0f0f0 !important;
                font-weight: bold;
                text-align: center;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Page break settings */
            .table {
                page-break-inside: auto;
            }
            
            .table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            /* Print summary info */
            .print-summary {
                display: block !important;
                margin-bottom: 15px;
                font-size: 12px;
            }
        }
        
        .print-summary {
            display: none;
        }
    </style>
</head>
<body class="bg-light">

<div class="wrapper">
        <!-- Sidebar -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3><i class="bi bi-airplane-fill"></i> AMC</h3>
            <p class="mb-0">Sultan Syarif Kasim II</p>
        </div>

        <ul class="list-unstyled components">
            <li>
                <a href="dashboard.html">
                    <i class="bi bi-house"></i> Dashboard
                </a>
            </li>
            <li>
                <a href="checklist.html">
                    <i class="bi bi-card-checklist"></i> Checklist
                </a>
            </li>
            <li>
                <a href="logbook.html">
                    <i class="bi bi-journal-check"></i> Logbook
                </a>
            </li>
            <li>
                <a href="admintim.html">
                    <i class="bi bi-display"></i> Admin TIM
                </a>
            </li>
            <li>
                <a href="#" onclick="showHome(); setActiveMenu(this); return false;" class="active">
                    <i class="bi bi-journal-plus"></i> Avio Logbook
                </a>
            </li>
            <li>
                <a href="avio_checklist.html">
                    <i class="bi bi-person-check"></i> Avio Checklist
                </a>
            </li>
             <li>
                <a href="#" onclick="logout(); return false;">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </li>
        </ul>

        <div class="px-3 mt-auto pb-3">
            <small class="text-white-50">Apron Movement Control PKU</small>
        </div>
    </nav>

    <!-- Page Content -->
    <div id="content">
        <button type="button" id="sidebarCollapse" class="btn mb-3">
            <i class="bi bi-list"></i> Menu
        </button>

        <div id="homePage">

    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <h3 class="text-primary"><i class="bi bi-airplane-engines-fill"></i> Logbook Aviobridge</h3>
        <div>
            <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#modalCetak">
                <i class="bi bi-printer"></i> Laporan
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalTambahData">
                <i class="bi bi-plus-lg"></i> Input Data
            </button>
        </div>
    </div>

    <!-- Print Header - Only visible when printing -->
    <div class="print-header">
        <h2>APRON MOVEMENT CONTROL</h2>
        <h3>Bandar Udara Sultan Syarif Kasim II Pekanbaru</h3>
        <p>LOGBOOK AVIOBRIDGE</p>
        <p id="printDateRange"></p>
    </div>

    <!-- Print Summary - Only visible when printing -->
    <div class="print-summary">
        <strong>Total Data: <span id="printTotalData">0</span></strong> | 
        <strong>Dicetak: <span id="printDateTime"></span></strong>
    </div>

    <div class="card">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Daftar Log Harian</h6>
            <span class="badge bg-secondary" id="totalData">0 Data</span>
        </div>
        <div class="card-body p-0">
            <!-- Search/Filter Bar -->
            <div class="p-3 border-bottom no-print">
                <div class="row g-2">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="searchInput" 
                                   placeholder="Cari berdasarkan Flight, Reg, Rute, Type, Stand, Operator..."
                                   onkeyup="filterTable()">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                <i class="bi bi-x-lg"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="filterLeg" onchange="filterTable()">
                            <option value="">Semua Leg (A/D)</option>
                            <option value="A">Arrival (A)</option>
                            <option value="D">Departure (D)</option>
                        </select>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> 
                        Menampilkan <strong id="filteredCount">0</strong> dari <strong id="totalCount">0</strong> data
                    </small>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-striped align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Tanggal</th>
                            <th>Flight</th>
                            <th>Reg</th>
                            <th>Rute</th>
                            <th>Leg</th>
                            <th>Dom/Intl</th>
                            <th>Type</th>
                            <th>Stand</th>
                            <th>Block Time</th>
                            <th>Operator</th>
                            <th>Foto</th>
                            <th class="no-print">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="12" class="text-center py-4">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalTambahData" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Input Logbook Baru</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formLogbook">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tanggal</label>
                            <input type="date" class="form-control" id="inputTanggal" required>
                        </div>
                                               
                        <div class="col-md-6">
                            <label class="form-label">Registration</label>
                            <input type="text" class="form-control" id="inputReg" placeholder="PK-..." required>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Flight Number</label>
                            <div class="input-group">
                                <select class="selectpicker" id="selectFlight" data-live-search="true" required><option value="">Pilih...</option></select>
                                <button class="btn btn-outline-secondary" type="button" onclick="tambahDB('Flight Number', 'flight_number')">+</button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Aircraft Type</label>
                            <div class="input-group">
                                <select class="selectpicker" id="selectType" data-live-search="true" required><option value="">Pilih...</option></select>
                                <button class="btn btn-outline-secondary" type="button" onclick="tambahDB('Aircraft Type', 'aircraft_type')">+</button>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Rute</label>
                            <div class="input-group">
                                <select class="form-select" id="selectRute" required><option value="">Pilih...</option></select>
                                <button class="btn btn-outline-secondary" type="button" onclick="tambahDB('Rute', 'rute')">+</button>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Leg (A/D)</label>
                            <select class="form-select" id="selectLeg" required>
                                <option value="A">Arrival (A)</option>
                                <option value="D">Departure (D)</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">DOM/INTL</label>
                            <select class="form-select" id="selectDom_Intl" required>
                                <option value="DOM">Domestik</option>
                                <option value="INTL">Internasional</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Parking Stand</label>
                            <div class="input-group">
                                <select class="form-select" id="selectStand" required><option value="">Pilih...</option></select>
                                <button class="btn btn-outline-secondary" type="button" onclick="tambahDB('Stand', 'parking_stand')">+</button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Block Time</label>
                            <input type="time" class="form-control" id="inputBlockTime" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Nama Operator</label>
                            <div class="input-group">
                                <select class="form-select" id="selectOperator" required><option value="">Pilih...</option></select>
                                <button class="btn btn-outline-secondary" type="button" onclick="tambahDB('Operator', 'operator_name')">+</button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Upload Foto</label>
                            <input type="file" class="form-control" id="inputFoto" accept="image/*">
                        </div>

                        <div class="col-12">
                            <label class="form-label">Incident (If Any)</label>
                            <textarea class="form-control" id="inputIncident" rows="2" placeholder="Ketik '-' jika nihil"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" onclick="simpanData()">
                    <span id="btnLoading" class="spinner-border spinner-border-sm d-none"></span>
                    Simpan Data
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCetak" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Filter Laporan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-6">
                        <label>Dari Tanggal</label>
                        <input type="date" id="filterStart" class="form-control">
                    </div>
                    <div class="col-6">
                        <label>Sampai Tanggal</label>
                        <input type="date" id="filterEnd" class="form-control">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-100" onclick="filterDanCetak()">
                    <i class="bi bi-printer-fill"></i> Terapkan & Cetak
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

<script>
    // --- 1. KONFIGURASI SUPABASE ---
    // Use the supabaseClient already initialized in the head section
    const BUCKET_NAME = 'logbook-foto'; // Pastikan bucket ini ada di Supabase Storage

    // Global variable to store all data
    let allData = [];

    // --- 2. FUNGSI LOAD DATA UTAMA ---
    async function loadTable(startDate = null, endDate = null) {
        let query = supabaseClient
            .from('aviobridge_log')
            .select('*')
            .order('tanggal', { ascending: false });

        // Filter Tanggal jika ada (untuk fitur cetak)
        if (startDate && endDate) {
            query = query.gte('tanggal', startDate).lte('tanggal', endDate);
        }

        const { data, error } = await query;
        const tbody = document.getElementById('tableBody');
        
        if (error) {
            console.error('Error:', error);
            tbody.innerHTML = `<tr><td colspan="12" class="text-danger">Gagal memuat data: ${error.message}</td></tr>`;
            return;
        }

        // Store data globally for filtering
        allData = data;
        
        // Update total count
        document.getElementById('totalData').innerText = data.length + ' Data';
        document.getElementById('totalCount').innerText = data.length;
        document.getElementById('filteredCount').innerText = data.length;

        // Render table
        renderTable(data);
    }

    // --- 2B. FUNGSI RENDER TABLE ---
    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="12" class="text-center text-muted py-4">Tidak ada data yang sesuai dengan filter</td></tr>`;
            return;
        }

        data.forEach(item => {
            // Cek ada foto atau tidak
            let fotoDisplay = item.photo_url 
                ? `<a href="${item.photo_url}" target="_blank"><img src="${item.photo_url}" title="Klik untuk perbesar"></a>` 
                : '<span class="text-muted small">-</span>';

            let row = `
                <tr>
                    <td>${item.tanggal}</td>
                    <td><strong>${item.flight_number}</strong></td>
                    <td>${item.registration}</td>
                    <td>${item.rute || '-'}</td>
                    <td><span class="badge ${item.leg === 'A' ? 'bg-info' : 'bg-warning text-dark'}">${item.leg}</span></td>
                    <td><span class="badge ${item.dom_intl === 'Dom' ? 'bg-info' : 'bg-warning text-dark'}">${item.dom_intl}</span></td>
                    <td>${item.aircraft_type}</td>
                    <td>${item.parking_stand}</td>
                    <td>${item.block_time || '-'}</td>
                    <td>${item.operator_name}</td>
                    <td>${fotoDisplay}</td>
                    <td class="no-print">
                        <button class="btn btn-sm btn-outline-danger" onclick="hapusData('${item.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // --- 2C. FUNGSI FILTER TABLE ---
    function filterTable() {
        const searchValue = document.getElementById('searchInput').value.toLowerCase();
        const legFilter = document.getElementById('filterLeg').value;

        let filteredData = allData.filter(item => {
            // Text search across multiple fields
            const searchMatch = 
                (item.flight_number || '').toLowerCase().includes(searchValue) ||
                (item.registration || '').toLowerCase().includes(searchValue) ||
                (item.rute || '').toLowerCase().includes(searchValue) ||
                (item.aircraft_type || '').toLowerCase().includes(searchValue) ||
                (item.parking_stand || '').toLowerCase().includes(searchValue) ||
                (item.operator_name || '').toLowerCase().includes(searchValue) ||
                (item.tanggal || '').toLowerCase().includes(searchValue) ||
                (item.block_time || '').toLowerCase().includes(searchValue);

            // Leg filter
            const legMatch = !legFilter || item.leg === legFilter;

            return searchMatch && legMatch;
        });

        // Update filtered count
        document.getElementById('filteredCount').innerText = filteredData.length;

        // Render filtered data
        renderTable(filteredData);
    }

    // --- 2D. FUNGSI CLEAR SEARCH ---
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('filterLeg').value = '';
        filterTable();
    }

    // --- 3. FUNGSI LOAD DROPDOWN (DATABASE OTOMATIS) ---
    async function loadDropdowns() {
        const { data, error } = await supabaseClient.from('settings_data').select('*');
        if (error || !data) return;

        const mapID = {
            'flight_number': 'selectFlight',
            'aircraft_type': 'selectType',
            'rute': 'selectRute',
            'parking_stand': 'selectStand',
            'operator_name': 'selectOperator'
        };

        for (let key in mapID) {
            let select = document.getElementById(mapID[key]);
            if (!select) continue;
            
            // FIX: Bedakan perlakuan untuk selectpicker vs standard select
            // Selectpicker menggunakan attribute 'title' di HTML sebagai placeholder, jadi innerHTML harus kosong
            if (select.classList.contains('selectpicker')) {
                select.innerHTML = ''; 
            } else {
                select.innerHTML = '<option value="">Pilih...</option>';
            }

            let options = data.filter(item => item.category === key);
            let uniqueValues = [...new Set(options.map(item => item.value))];
            
            uniqueValues.sort().forEach(val => {
                let el = document.createElement('option');
                el.value = val;
                el.text = val;
                select.add(el);
            });
        }
        
        // Refresh bootstrap-select
        try {
            $('#selectFlight').selectpicker('refresh');
            $('#selectType').selectpicker('refresh');
        } catch(e) {}
    }

    async function tambahDB(label, cat) {
        let val = prompt(`Tambah ${label}:`);
        if (!val) return;
        await supabaseClient.from('settings_data').insert([{ category: cat, value: val }]);
        await loadDropdowns();
    }

    // --- 5. FUNGSI SIMPAN DATA (UPLOAD + INSERT) ---
    async function simpanData() {
        // Validasi Form Sederhana
        const tgl = document.getElementById('inputTanggal').value;
        const flt = document.getElementById('selectFlight').value;
        if (!tgl || !flt) { alert("Tanggal dan Flight Number wajib diisi!"); return; }

        // UI Loading
        const btn = document.querySelector('button[onclick="simpanData()"]');
        const spinner = document.getElementById('btnLoading');
        btn.disabled = true;
        spinner.classList.remove('d-none');

        try {
            let finalPhotoUrl = null;
            
            // A. Proses Upload Foto (Jika ada)
            const fileInput = document.getElementById('inputFoto');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileName = `log_${Date.now()}_${file.name.replace(/\s+/g, '-')}`;

                const { data: uploadData, error: uploadError } = await supabaseClient
                    .storage
                    .from(BUCKET_NAME)
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                // Ambil Public URL
                const { data: publicUrlData } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(fileName);
                finalPhotoUrl = publicUrlData.publicUrl;
            }

            // B. Insert Data ke Tabel
            const payload = {
                tanggal: tgl,
                flight_number: flt,
                registration: document.getElementById('inputReg').value,
                rute: document.getElementById('selectRute').value,
                leg: document.getElementById('selectLeg').value,
                dom_intl: document.getElementById('selectDom_Intl').value,
                aircraft_type: document.getElementById('selectType').value,
                parking_stand: document.getElementById('selectStand').value,
                block_time: document.getElementById('inputBlockTime').value,
                operator_name: document.getElementById('selectOperator').value,
                incident: document.getElementById('inputIncident').value,
                photo_url: finalPhotoUrl
            };

            const { error: insertError } = await supabaseClient.from('aviobridge_log').insert([payload]);
            if (insertError) throw insertError;

            // Berhasil
            alert("Data Berhasil Disimpan!");
            document.getElementById('formLogbook').reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalTambahData'));
            modal.hide();
            loadTable(); // Reload tabel

        } catch (err) {
            alert("Terjadi Kesalahan: " + err.message);
        } finally {
            btn.disabled = false;
            spinner.classList.add('d-none');
        }
    }

    // --- 6. FUNGSI HAPUS ---
    async function hapusData(id) {
        if (!confirm("Yakin ingin menghapus data ini?")) return;
        const { error } = await supabaseClient.from('aviobridge_log').delete().eq('id', id);
        if (error) alert("Gagal hapus: " + error.message);
        else loadTable();
    }

    // --- 7. FUNGSI FILTER & CETAK ---
    async function filterDanCetak() {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        
        if (!start || !end) {
            alert("Harap isi kedua tanggal");
            return;
        }

        // Load data spesifik lalu print
        await loadTable(start, end);
        
        // Update print header information
        const startDate = new Date(start).toLocaleDateString('id-ID', { 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        });
        const endDate = new Date(end).toLocaleDateString('id-ID', { 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        });
        
        document.getElementById('printDateRange').textContent = 
            `Periode: ${startDate} - ${endDate}`;
        
        // Update print summary
        const totalData = document.getElementById('totalData').textContent;
        document.getElementById('printTotalData').textContent = totalData;
        
        const now = new Date().toLocaleString('id-ID', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('printDateTime').textContent = now;
        
        // Tutup modal lalu print
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalCetak'));
        modal.hide();
        
        setTimeout(() => {
            window.print();
            // Reload semua data setelah print selesai
            setTimeout(() => {
                loadTable();
            }, 1000);
        }, 500);
    }

    // --- INITIALIZATION ---
    window.onload = async function() {
        await loadDropdowns();
        loadTable();
        document.getElementById('inputTanggal').value = new Date().toISOString().split('T')[0];
    };

    // Fungsi untuk set active menu
function setActiveMenu(element) {
    // Remove active class from all menu items
    document.querySelectorAll('#sidebar ul li a').forEach(link => {
        link.classList.remove('active');
    });
    // Add active class to clicked item
    element.classList.add('active');
}

// Toggle sidebar
document.addEventListener('DOMContentLoaded', function() {
    // Sidebar toggle functionality
    const sidebarCollapse = document.getElementById('sidebarCollapse');
    const sidebar = document.getElementById('sidebar');
    const content = document.getElementById('content');

    if (sidebarCollapse) {
        sidebarCollapse.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            content.classList.toggle('active');
        });
    }
});
</script>

</body>
</html>



