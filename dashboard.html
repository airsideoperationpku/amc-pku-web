<!DOCTYPE html>
<html lang="id">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>

    <link rel="manifest" href="manifest.json">

    <link rel="apple-touch-icon" href="https://i.imgur.com/Sv74lxN.png">
    <meta name="apple-mobile-web-app-status-bar" content="#0d6efd">
    <meta name="theme-color" content="#0d6efd">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="assets/logic.js"></script>
    <style>
        .hidden { display: none; }
        .form-check-input { cursor: pointer; border: 1px solid #0d6efd; }
        
        /* Sidebar Styles */
        #sidebar {
            position: absolute;
            top: 0;
            left: 0;
            min-width: 250px;
            max-width: 250px;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            transition: all 0.3s;
            min-height: 100vh;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #sidebar.active {
            left: -250px;
        }

        #sidebar .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
        }

        #sidebar ul.components {
            padding: 20px 0;
        }

        #sidebar ul li {
            padding: 10px;
            font-size: 1.1em;
            display: block;
        }

        #sidebar ul li a {
            padding: 10px 15px;
            font-size: 1em;
            display: block;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-radius: 5px;
        }

        #sidebar ul li a:hover,
        #sidebar ul li a.active {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }

        #sidebar ul li a i {
            margin-right: 10px;
        }

        #content {
            margin-left: 250px;
            width: calc(100% - 250px);
            padding: 20px;
            min-height: 100vh;
            transition: all 0.3s;
        }

        #sidebar.active ~ #content {
            margin-left: 0;
            width: 100%;
        }

        .wrapper {
            width: 100%;
            position: relative;
        }
        
        #sidebarCollapse {
            background: #1e3c72;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1001;
        }
        
        #sidebarCollapse:hover {
            background: #2a5298;
        }

    </style>
</head>
<body class="bg-light">

<!-- Sidebar -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3><i class="bi bi-airplane-fill"></i> AMC</h3>
            <p class="mb-0">Sultan Syarif Kasim II</p>
        </div>

        <ul class="list-unstyled components">
            <li>
                <a href="#" onclick="showHome(); setActiveMenu(this); return false;" class="active">
                    <i class="bi bi-house"></i> Dashboard
                </a>
            </li>
            <li>
                <a href="checklist.html">
                    <i class="bi bi-card-checklist"></i> Checklist
                </a>
            </li>
            <li>
                <a href="logbook.html">
                    <i class="bi bi-journal-check"></i> Logbook
                </a>
            </li>
            <li>
                <a href="admintim.html">
                    <i class="bi bi-display"></i> Admin TIM
                </a>
            </li>
            <li>
                <a href="avio_logbook.html">
                    <i class="bi bi-journal-plus"></i> Avio Logbook
                </a>
            </li>
            <li>
                <a href="avio_checklist.html">
                    <i class="bi bi-person-check"></i> Avio Checklist
                </a>
            </li>
             <li>
                <a href="#" onclick="logout(); return false;">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </li>
        </ul>

        <div class="px-3 mt-auto pb-3">
            <small class="text-white-50">Apron Movement Control PKU</small>
        </div>
    </nav>

    <!-- Page Content -->
    <div id="content">
        <button type="button" id="sidebarCollapse" class="btn btn-primary mb-3 shadow-sm" onclick="toggleSidebar()">
            <i class="bi bi-list"></i> Menu
        </button>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="text-primary fw-bold"><i class="bi bi-speedometer2"></i> Dashboard Aviobridge</h3>
                <p class="text-muted mb-0">Login sebagai: <span id="userEmail" class="fw-bold">Loading...</span></p>
            </div>
            <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </button>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div><h6 class="text-muted mb-1">Total Operations</h6><h2 class="mb-0" id="totalOperations">0</h2></div>
                            <div class="bg-primary bg-opacity-10 p-3 rounded"><i class="bi bi-airplane-engines text-primary fs-3"></i></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div><h6 class="text-muted mb-1">Arrivals</h6><h2 class="mb-0 text-info" id="totalArrivals">0</h2></div>
                            <div class="bg-info bg-opacity-10 p-3 rounded"><i class="bi bi-airplane-fill text-info fs-3"></i></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div><h6 class="text-muted mb-1">Departures</h6><h2 class="mb-0 text-warning" id="totalDepartures">0</h2></div>
                            <div class="bg-warning bg-opacity-10 p-3 rounded"><i class="bi bi-airplane text-warning fs-3"></i></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div><h6 class="text-muted mb-1">Stand Used</h6><h2 class="mb-0 text-success" id="totalStandsUsed">0</h2></div>
                            <div class="bg-success bg-opacity-10 p-3 rounded"><i class="bi bi-p-square text-success fs-3"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-12">
                <h5 class="text-secondary fw-bold"><i class="bi bi-check-circle-fill"></i> Status Kondisi Aviobridge (Real-time)</h5>
            </div>
            
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100 status-card status-unknown" id="cardStatus_D5">
                    <div class="card-body">
                        <h6 class="text-muted fw-bold">Aviobridge D.05</h6>
                        <h4 class="mb-2 fw-bold" id="statusText_D5">Checking...</h4>
                        <div class="d-flex align-items-center mt-3">
                            <i class="bi bi-clock-history me-2"></i>
                            <small class="text-muted lh-1" id="lastCheck_D5">-</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100 status-card status-unknown" id="cardStatus_D6">
                    <div class="card-body">
                        <h6 class="text-muted fw-bold">Aviobridge D.06</h6>
                        <h4 class="mb-2 fw-bold" id="statusText_D6">Checking...</h4>
                        <div class="d-flex align-items-center mt-3">
                            <i class="bi bi-clock-history me-2"></i>
                            <small class="text-muted lh-1" id="lastCheck_D6">-</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100 status-card status-unknown" id="cardStatus_D7">
                    <div class="card-body">
                        <h6 class="text-muted fw-bold">Aviobridge D.07</h6>
                        <h4 class="mb-2 fw-bold" id="statusText_D7">Checking...</h4>
                        <div class="d-flex align-items-center mt-3">
                            <i class="bi bi-clock-history me-2"></i>
                            <small class="text-muted lh-1" id="lastCheck_D7">-</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100 status-card status-unknown" id="cardStatus_D8">
                    <div class="card-body">
                        <h6 class="text-muted fw-bold">Aviobridge D.08</h6>
                        <h4 class="mb-2 fw-bold" id="statusText_D8">Checking...</h4>
                        <div class="d-flex align-items-center mt-3">
                            <i class="bi bi-clock-history me-2"></i>
                            <small class="text-muted lh-1" id="lastCheck_D8">-</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-7">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h6 class="m-0 text-primary fw-bold"><i class="bi bi-bar-chart-line"></i> Statistik Penggunaan (Logbook)</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Aviobridge</th>
                                        <th class="text-center">Total Ops</th>
                                        <th class="text-center">Arrival</th>
                                        <th class="text-center">Departure</th>
                                    </tr>
                                </thead>
                                <tbody id="allStandsTableBody">
                                    <tr><td colspan="4" class="text-center py-3">Loading data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h6 class="m-0 text-primary fw-bold"><i class="bi bi-globe"></i> Domestik vs Internasional</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="p-3 bg-light rounded border">
                                    <h6 class="text-muted mb-2 small">Domestik</h6>
                                    <h2 class="mb-0 text-primary" id="totalDomestic">0</h2>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-light rounded border">
                                    <h6 class="text-muted mb-2 small">Internasional</h6>
                                    <h2 class="mb-0 text-success" id="totalInternational">0</h2>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="d-flex justify-content-between small text-muted mb-1">
                                <span>Persentase Domestik</span>
                                <span id="domesticPercentage">0%</span>
                            </div>
                            <div class="progress mb-3" style="height: 6px;">
                                <div class="progress-bar" id="progDom" role="progressbar" style="width: 0%"></div>
                            </div>
                            
                            <div class="d-flex justify-content-between small text-muted mb-1">
                                <span>Persentase Internasional</span>
                                <span id="internationalPercentage">0%</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" id="progIntl" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h6 class="m-0 text-primary fw-bold"><i class="bi bi-clock-history"></i> Logbook Terbaru (10 Transaksi Terakhir)</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0 text-sm">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Flight No</th>
                                        <th>Reg</th>
                                        <th>Rute</th>
                                        <th>Leg</th>
                                        <th>Type</th>
                                        <th>Stand</th>
                                        <th>Operator</th>
                                    </tr>
                                </thead>
                                <tbody id="recentActivityBody">
                                    <tr><td colspan="8" class="text-center py-3">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- KONFIGURASI SUPABASE ---
    const supabaseUrl = 'https://voqvauapafsdcmuswsnq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvcXZhdWFwYWZzZGNtdXN3c25xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNDMxNTYsImV4cCI6MjA4MTcxOTE1Nn0.IJG7ofqfc4Qy44KlbTDGzo4OoQwO0xTXUwKPt04kRnI';
    
    // Inisialisasi Client
    if (typeof window.supabase !== 'undefined') {
        window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
    }

    // --- UTILITY: NORMALISASI NAMA STAND (PERBAIKAN UTAMA DISINI) ---
    // Mengubah "D.05", "D 05", "D05" menjadi "D5" yang seragam
    function normalizeStandName(name) {
        if (!name) return "UNKNOWN";
        // 1. Hapus titik, spasi, dash, dan ubah ke huruf besar
        // Contoh input: "D.05" -> jadi "D05"
        let clean = name.replace(/[\.\s\-]/g, '').toUpperCase();
        
        // 2. Handle nol di depan angka (contoh: D05 -> D5)
        // Jika formatnya D + 0 + Angka, buang 0 nya.
        clean = clean.replace(/^D0+(\d+)/, 'D$1');
        
        return clean;
    }

    // --- CEK SESI ---
    async function checkAuth() {
        const { data: { session } } = await window.supabaseClient.auth.getSession();
        if (!session) {
            window.location.href = 'index.html';
        } else {
            document.getElementById('userEmail').innerText = session.user.email;
        }
    }

    // --- MAIN FUNCTION: REFRESH DATA ---
    async function refreshDashboard() {
        // Reset UI indicators
        document.getElementById('totalOperations').innerText = '...';
        
        await Promise.all([
            loadLogbookStats(), // Untuk Total, Dom/Intl, Tabel Penggunaan
            loadAvioStatus()    // Untuk Status Serviceable/Unserviceable (D5-D8)
        ]);
    }

    // --- 1. LOAD DATA LOGBOOK & HITUNG STATISTIK ---
    async function loadLogbookStats() {
        // Ambil semua data logbook
        const { data, error } = await window.supabaseClient
            .from('aviobridge_log')
            .select('*')
            .order('tanggal', { ascending: false });

        if (error) {
            console.error('Logbook Error:', error);
            return;
        }

        // --- Perhitungan Total ---
        const totalOps = data.length;
        const arrivals = data.filter(i => i.leg === 'A').length;
        const departures = data.filter(i => i.leg === 'D').length;

        // Hitung Unique Stand yang digunakan (Normalized)
        const usedStands = new Set(data.map(i => normalizeStandName(i.parking_stand)));

        // Update Summary Cards
        document.getElementById('totalOperations').innerText = totalOps;
        document.getElementById('totalArrivals').innerText = arrivals;
        document.getElementById('totalDepartures').innerText = departures;
        document.getElementById('totalStandsUsed').innerText = usedStands.size;

        // --- Domestik vs Internasional ---
        const domestic = data.filter(i => (i.dom_intl || '').toLowerCase().includes('dom')).length;
        const international = data.filter(i => (i.dom_intl || '').toLowerCase().includes('intl')).length;
        
        document.getElementById('totalDomestic').innerText = domestic;
        document.getElementById('totalInternational').innerText = international;

        const pctDom = totalOps ? ((domestic/totalOps)*100).toFixed(1) : 0;
        const pctIntl = totalOps ? ((international/totalOps)*100).toFixed(1) : 0;

        document.getElementById('domesticPercentage').innerText = pctDom + '%';
        document.getElementById('internationalPercentage').innerText = pctIntl + '%';
        document.getElementById('progDom').style.width = pctDom + '%';
        document.getElementById('progIntl').style.width = pctIntl + '%';

        // --- Tabel Statistik Penggunaan Per Stand ---
        const standStats = {};
        
        data.forEach(row => {
            const standRaw = row.parking_stand;
            if(!standRaw) return;
            
            const standKey = normalizeStandName(standRaw); // Group by normalized name (D5, D6, etc)
            
            // Format tampilan label: "Aviobridge D.05" (Tambahkan 0 biar rapi jika < 10)
            let suffix = standKey.replace('D', '');
            if(suffix.length === 1) suffix = '0' + suffix; 
            const displayLabel = `Aviobridge D.${suffix}`;

            if(!standStats[standKey]) {
                standStats[standKey] = { label: displayLabel, total: 0, arr: 0, dep: 0 };
            }
            
            standStats[standKey].total++;
            if(row.leg === 'A') standStats[standKey].arr++;
            if(row.leg === 'D') standStats[standKey].dep++;
        });

        // Convert to array & Sort
        const sortedStats = Object.values(standStats).sort((a,b) => b.total - a.total);
        
        const tableBody = document.getElementById('allStandsTableBody');
        tableBody.innerHTML = '';
        
        if(sortedStats.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada data logbook</td></tr>';
        } else {
            sortedStats.forEach(s => {
                tableBody.innerHTML += `
                    <tr>
                        <td class="fw-bold">${s.label}</td>
                        <td class="text-center"><span class="badge bg-primary">${s.total}</span></td>
                        <td class="text-center text-info fw-bold">${s.arr}</td>
                        <td class="text-center text-warning fw-bold">${s.dep}</td>
                    </tr>
                `;
            });
        }

        // --- Recent Activity (Top 10) ---
        renderRecentActivity(data.slice(0, 10));
    }

    function renderRecentActivity(recentData) {
        const tbody = document.getElementById('recentActivityBody');
        tbody.innerHTML = '';
        if (recentData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-3 text-muted">Tidak ada aktivitas baru</td></tr>';
            return;
        }
        recentData.forEach(item => {
            const legBadge = item.leg === 'A' 
                ? '<span class="badge bg-info">A</span>' 
                : '<span class="badge bg-warning text-dark">D</span>';
            tbody.innerHTML += `
                <tr>
                    <td>${item.tanggal}<br><small class="text-muted">${item.jam_block_on || ''}</small></td>
                    <td class="fw-bold">${item.flight_number || '-'}</td>
                    <td>${item.registration || '-'}</td>
                    <td>${item.rute || '-'}</td>
                    <td>${legBadge}</td>
                    <td>${item.aircraft_type || '-'}</td>
                    <td><span class="badge bg-secondary">${item.parking_stand || '-'}</span></td>
                    <td>${item.operator_name || '-'}</td>
                </tr>
            `;
        });
    }

    // --- 2. LOAD STATUS CHECKLIST (SERVICEABLE / UNSERVICEABLE) ---
    async function loadAvioStatus() {
        // Ambil SEMUA checklist, urutkan dari terbaru
        // Supaya kita dapat status terakhir untuk setiap stand
        const { data, error } = await window.supabaseClient
            .from('aviobridge_checklist')
            .select('parking_stand, kondisi_utama, tanggal, waktu')
            .order('tanggal', { ascending: false })
            .order('waktu', { ascending: false });

        if (error) {
            console.error('Checklist Error:', error);
            return;
        }

        // Map status terakhir untuk D5, D6, D7, D8
        // Kunci di map ini HARUS cocok dengan hasil normalizeStandName ("D5", "D6", dst)
        const statusMap = {
            'D5': { status: 'Unknown', time: '-' },
            'D6': { status: 'Unknown', time: '-' },
            'D7': { status: 'Unknown', time: '-' },
            'D8': { status: 'Unknown', time: '-' }
        };

        // Iterasi data dari yang terbaru. 
        data.forEach(row => {
            // Normalisasi nama dari DB (misal "D.05" -> jadi "D5")
            const key = normalizeStandName(row.parking_stand);
            
            // Cek apakah key valid (D5-D8) dan belum diisi (karena kita butuh yang terbaru saja)
            if (statusMap[key] && statusMap[key].status === 'Unknown') {
                statusMap[key] = {
                    status: row.kondisi_utama, // "Serviceable" atau "Unserviceable"
                    time: `${row.tanggal} ${row.waktu}`
                };
            }
        });

        // Update UI Cards
        updateStatusCard('D5', statusMap['D5']);
        updateStatusCard('D6', statusMap['D6']);
        updateStatusCard('D7', statusMap['D7']);
        updateStatusCard('D8', statusMap['D8']);
    }

    function updateStatusCard(standId, data) {
        const card = document.getElementById(`cardStatus_${standId}`);
        const text = document.getElementById(`statusText_${standId}`);
        const time = document.getElementById(`lastCheck_${standId}`);

        if (!card) return;

        // Reset Classes
        card.classList.remove('status-serviceable', 'status-unserviceable', 'status-unknown');

        // Logic pewarnaan
        if (data.status === 'Serviceable') {
            card.classList.add('status-serviceable');
            text.innerText = 'SERVICEABLE';
            text.className = 'mb-2 fw-bold text-success';
        } else if (data.status === 'Unserviceable') {
            card.classList.add('status-unserviceable');
            text.innerText = 'UNSERVICEABLE';
            text.className = 'mb-2 fw-bold text-danger';
        } else {
            card.classList.add('status-unknown');
            text.innerText = 'NO DATA';
            text.className = 'mb-2 fw-bold text-secondary';
        }

        time.innerText = `Update: ${data.time}`;
    }

    // --- SIDEBAR TOGGLE ---
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const wrapper = document.querySelector('.wrapper');
        sidebar.classList.toggle('active');
        wrapper.classList.toggle('sidebar-hidden');
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        refreshDashboard();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
